////////////////////////////////////////////////////////////////
// @file main_filter.c
// @brief A sample application.
////////////////////////////////////////////////////////////////

#include "graph.h"

#define MAX_CONSTRAINTS_COUNT 1024

long long int in_count = 0;
long long int out_count = 0;

graph G;

////////////////////////////////////////////////////////////////
//
////////////////////////////////////////////////////////////////
int constraint_V_eq(const graph *G, int value) {
  int result = (G->vertex_count == value);
  return result;
}

////////////////////////////////////////////////////////////////
//
////////////////////////////////////////////////////////////////
int constraint_V_gt(const graph *G, int value) {
  int result = (G->vertex_count > value);
  return result;
}

////////////////////////////////////////////////////////////////
//
////////////////////////////////////////////////////////////////
int constraint_V_lt(const graph *G, int value) {
  int result = (G->vertex_count < value);
  return result;
}

////////////////////////////////////////////////////////////////
//
////////////////////////////////////////////////////////////////
int constraint_E_eq(const graph *G, int value) {
  int result = (count_edges(G) == value);
  return result;
}

////////////////////////////////////////////////////////////////
//
////////////////////////////////////////////////////////////////
int constraint_E_gt(const graph *G, int value) {
  int result = (count_edges(G) > value);
  return result;
}

////////////////////////////////////////////////////////////////
//
////////////////////////////////////////////////////////////////
int constraint_E_lt(const graph *G, int value) {
  int result = (count_edges(G) < value);
  return result;
}

////////////////////////////////////////////////////////////////
//
////////////////////////////////////////////////////////////////
int constraint_d_eq(const graph *G, int value) {
  int result = (min_degree(G) == value);
  return result;
}

////////////////////////////////////////////////////////////////
//
////////////////////////////////////////////////////////////////
int constraint_d_gt(const graph *G, int value) {
  int result = (min_degree(G) > value);
  return result;
}

////////////////////////////////////////////////////////////////
//
////////////////////////////////////////////////////////////////
int constraint_d_lt(const graph *G, int value) {
  int result = (min_degree(G) < value);
  return result;
}

////////////////////////////////////////////////////////////////
//
////////////////////////////////////////////////////////////////
int constraint_D_eq(const graph *G, int value) {
  int result = (max_degree(G) == value);
  return result;
}

////////////////////////////////////////////////////////////////
//
////////////////////////////////////////////////////////////////
int constraint_D_gt(const graph *G, int value) {
  int result = (max_degree(G) > value);
  return result;
}

////////////////////////////////////////////////////////////////
//
////////////////////////////////////////////////////////////////
int constraint_D_lt(const graph *G, int value) {
  int result = (max_degree(G) < value);
  return result;
}

////////////////////////////////////////////////////////////////
//
////////////////////////////////////////////////////////////////
int constraint_w_eq(const graph *G, int value) {
  int result = (find_Kn(G, value) && !find_Kn(G, value + 1));
  return result;
}

////////////////////////////////////////////////////////////////
//
////////////////////////////////////////////////////////////////
int constraint_w_gt(const graph *G, int value) {
  int result = find_Kn(G, value + 1);
  return result;
}

////////////////////////////////////////////////////////////////
//
////////////////////////////////////////////////////////////////
int constraint_w_lt(const graph *G, int value) {
  int result = !find_Kn(G, value);
  return result;
}

////////////////////////////////////////////////////////////////
//
////////////////////////////////////////////////////////////////
int constraint_a_eq(const graph *G, int value) {
  int result = (find_In(G, value) && !find_In(G, value + 1));
  return result;
}

////////////////////////////////////////////////////////////////
//
////////////////////////////////////////////////////////////////
int constraint_a_gt(const graph *G, int value) {
  int result = find_In(G, value + 1);
  return result;
}

////////////////////////////////////////////////////////////////
//
////////////////////////////////////////////////////////////////
int constraint_a_lt(const graph *G, int value) {
  int result = !find_In(G, value);
  return result;
}

////////////////////////////////////////////////////////////////
//
////////////////////////////////////////////////////////////////
int constraint_x_eq(const graph *G, int value) {
  int result = (!find_n_coloring(G, value - 1) && find_n_coloring(G, value));
  return result;
}

////////////////////////////////////////////////////////////////
//
////////////////////////////////////////////////////////////////
int constraint_x_gt(const graph *G, int value) {
  int result = !find_n_coloring(G, value);
  return result;
}

////////////////////////////////////////////////////////////////
//
////////////////////////////////////////////////////////////////
int constraint_x_lt(const graph *G, int value) {
  int result = find_n_coloring(G, value - 1);
  return result;
}

////////////////////////////////////////////////////////////////
//
////////////////////////////////////////////////////////////////
int constraint_connected_components_eq(const graph *G, int value) {
  int result = (count_connected_components(G) == value);
  return result;
}

////////////////////////////////////////////////////////////////
//
////////////////////////////////////////////////////////////////
int constraint_connected_components_gt(const graph *G, int value) {
  int result = (count_connected_components(G) > value);
  return result;
}

////////////////////////////////////////////////////////////////
//
////////////////////////////////////////////////////////////////
int constraint_connected_components_lt(const graph *G, int value) {
  int result = (count_connected_components(G) < value);
  return result;
}

////////////////////////////////////////////////////////////////
//
////////////////////////////////////////////////////////////////
int constraint_edge_adds_kn(const graph *G, int value) {
  int result = (check_edge_adds_kn(G, value));
  return result;
}

////////////////////////////////////////////////////////////////
//
////////////////////////////////////////////////////////////////
int constraint_sperner(const graph *G, int value) {
  int result = (check_sperner(G) == value);
  return result;
}

////////////////////////////////////////////////////////////////
//
////////////////////////////////////////////////////////////////
int (*constraints[]) (const graph *G, int value) = {
  constraint_V_eq,
  constraint_V_gt,
  constraint_V_lt,
  constraint_E_eq,
  constraint_E_gt,
  constraint_E_lt,
  constraint_d_eq,
  constraint_d_gt,
  constraint_d_lt,
  constraint_D_eq,
  constraint_D_gt,
  constraint_D_lt,
  constraint_w_eq,
  constraint_w_gt,
  constraint_w_lt,
  constraint_a_eq,
  constraint_a_gt,
  constraint_a_lt,
  constraint_x_eq,
  constraint_x_gt,
  constraint_x_lt,
  constraint_connected_components_eq,
  constraint_connected_components_gt,
  constraint_connected_components_lt,
  constraint_edge_adds_kn,
  constraint_sperner
};

////////////////////////////////////////////////////////////////
//
////////////////////////////////////////////////////////////////
const char *constraint_names[] = {
  "-V=",
  "-V>",
  "-V<",
  "-E=",
  "-E>",
  "-E<",
  "-d=",
  "-d>",
  "-d<",
  "-D=",
  "-D>",
  "-D<",
  "-w=",
  "-w>",
  "-w<",
  "-a=",
  "-a>",
  "-a<",
  "-x=",
  "-x>",
  "-x<",
  "-connected_components=",
  "-connected_components>",
  "-connected_components<",
  "-edge_adds_kn",
  "-sperner"
};

////////////////////////////////////////////////////////////////
//
////////////////////////////////////////////////////////////////
int constraints_count = sizeof(constraint_names) / sizeof(char *);

////////////////////////////////////////////////////////////////
//
////////////////////////////////////////////////////////////////
int index_of_constraint(const char *constraint_name) {
  int result = -1;
  int i;
  for(i = 0; i < constraints_count; ++i) {
    if(!strcmp(constraint_name, constraint_names[i])) {
      result = i;
      break;
    }
  }
  return result;
}

////////////////////////////////////////////////////////////////
// Entry point for the application.
////////////////////////////////////////////////////////////////
int main(int argc, char* argv[]) {

  int i;

  int (*arg_constraints[MAX_CONSTRAINTS_COUNT]) (const graph *G, int value);
  int arg_constraints_count = 0;
  int arg_values[MAX_CONSTRAINTS_COUNT];

  for(i = 1; i < argc; ++i) {
    int index = index_of_constraint(argv[i]);
    if(index == -1) {
      fprintf(stderr, "Usage:\nfilter [-constraint value] ...\n");
      return 1;
    }
    arg_constraints[arg_constraints_count] = constraints[index];
    arg_values[arg_constraints_count] = strtol(argv[i + 1], 0, 10);
    ++arg_constraints_count;
    ++i;
  }

  while(read_graph(&G)) {

    ++in_count;

    for(i = 0; i < arg_constraints_count; ++i) {
      if(!arg_constraints[i](&G, arg_values[i])) {
        break;
      }
    }
    if(i == arg_constraints_count) {
      ++out_count;
      write_graph(&G);
    }

  }

  fprintf(stderr, "in : %lld\n", in_count);

  fprintf(stderr, "out: %lld\n", out_count);

  fprintf(stderr, "\n");

  return 0;
}

